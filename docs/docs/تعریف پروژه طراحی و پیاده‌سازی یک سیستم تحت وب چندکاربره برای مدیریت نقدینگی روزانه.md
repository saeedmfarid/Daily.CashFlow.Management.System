# تعریف پروژه  
**سیستم مدیریت روزانه نقدینگی (Daily Cash Flow Management System)**  
با ورودی ERP + ثبت دستی + تقویم شمسی و میلادی

---

## ۱. هدف پروژه  
طراحی و پیاده‌سازی یک سیستم تحت وب چندکاربره برای مدیریت نقدینگی روزانه که:

- اطلاعات مالی را به‌صورت فقط خواندنی (Read-only) از ERP دریافت کند  
- امکان ثبت اطلاعات دستی مرتبط با جریان نقدی را فراهم کند  
- امکان اصلاح اطلاعات ERP از طریق لایه اصلاحات (Adjustment Layer) را بدهد  
- گزارش نقدینگی روزانه، هفتگی و پیش‌بینی تولید کند  
- به‌صورت همزمان از تقویم شمسی و میلادی پشتیبانی کند  
- تعطیلات و آخرهفته‌ها را در محاسبات لحاظ کند  
- کلیه تغییرات را به‌صورت Audit ثبت کند  

این سیستم مبنای تصمیم‌گیری مالی مدیریت خواهد بود.

---

## ۲. دامنه پروژه  
**در محدوده پروژه:**

- اتصال به ERP و خواندن اطلاعات مالی  
- ثبت اطلاعات دستی  
- اصلاح اطلاعات ERP بدون تغییر داده اصلی  
- موتور محاسبه نقدینگی  
- پشتیبانی کامل تقویم شمسی و میلادی  
- مدیریت تعطیلات  
- مدیریت کاربران و دسترسی‌ها  
- گزارش‌گیری و خروجی اکسل  
- ثبت لاگ تغییرات (Audit)

---

## ۳. منابع داده  

### ۳.۱ داده‌های ERP (فقط خواندنی)  
اطلاعات ERP از یکی از روش‌های زیر دریافت می‌شود:

- View دیتابیس  
- Import فایل CSV / Excel  

داده‌های ERP در سیستم داخلی قابل ویرایش نیستند.

**فیلدهای حداقلی ERP:**

- شناسه رکورد ERP  
- تاریخ سند  
- تاریخ سررسید  
- تاریخ اثر نقدینگی (Cash Effective Date)  
- طرف حساب  
- نوع تراکنش (ورودی / خروجی)  
- مبلغ  
- ارز  
- شماره سند  

**ذخیره در:**  
`erp_transactions` (یا View خارجی)

### ۳.۲ ثبت اطلاعات دستی (Manual Entries)  
اطلاعاتی که در ERP وجود ندارد یا پیش‌بینی مدیریتی است.  
**مثال:**

- پیش‌بینی وصول  
- پرداخت برنامه‌ریزی‌شده  
- حقوق و دستمزد  
- مالیات  
- تزریق نقدینگی  

**جدول:** `manual_entries`  

**فیلدها:**

- id  
- تاریخ اثر نقدینگی (میلادی)  
- نوع (ورودی / خروجی)  
- مبلغ  
- ارز  
- دسته‌بندی  
- توضیحات  
- ایجادکننده  
- تاریخ ایجاد  

---

## ۴. لایه اصلاحات ERP (Adjustment Layer)  
هیچ رکورد ERP مستقیماً ویرایش نمی‌شود.  
اصلاحات در جدول جداگانه ثبت می‌شوند.

**جدول:** `erp_adjustments`  

**فیلدها:**

- id  
- شناسه رکورد ERP  
- تاریخ اثر اصلاح‌شده (اختیاری)  
- مبلغ اصلاح‌شده (اختیاری)  
- دسته‌بندی  
- توضیح  
- ویرایش‌کننده  
- تاریخ ویرایش  

**قانون:**

- در صورت وجود اصلاح → داده اصلاح‌شده مبناست  
- در غیر این صورت → داده خام ERP مبناست  
- در صورت که تاریخ چک و یا پرداخت اتوماتیک نشان بدهد و آلارام بدهد.

---

## ۵. تاریخ اثر نقدینگی (Cash Effective Date)  
تمام محاسبات نقدینگی صرفاً بر اساس این تاریخ انجام می‌شود، نه تاریخ سند یا فاکتور.  

این فیلد باید در موارد زیر وجود داشته باشد:

- ERP  
- ثبت دستی  
- اصلاحات  

---

## ۶. موتور محاسبه نقدینگی  
برای هر روز **D**:

**ورودی(D):**

- مجموع ورودی‌های ERP (با اصلاحات)  
- مجموع ورودی‌های دستی  

**خروجی(D):**

- مجموع خروجی‌های ERP (با اصلاحات)  
- مجموع خروجی‌های دستی  

**مانده پایان روز:**  
مانده اول روز + ورودی – خروجی  

**نتایج در جدول:**  
`daily_cash_position`

---

## ۷. تقویم شمسی و میلادی (الزامی)  

**قانون ذخیره تاریخ:**

- تمام تاریخ‌ها در دیتابیس فقط به میلادی ذخیره می‌شوند (YYYY-MM-DD)  
- شمسی فقط در لایه نمایش استفاده می‌شود  

**رابط کاربری:**

- کاربر می‌تواند تاریخ را شمسی یا میلادی وارد کند  
- سیستم به‌صورت خودکار تبدیل می‌کند  
- تاریخ‌ها در گزارش‌ها به هر دو شکل نمایش داده می‌شوند  

---

## ۸. هفته‌ها  
پشتیبانی از دو نوع هفته:

- **هفته شمسی**: شنبه تا جمعه  
- **هفته میلادی**: شروع هفته قابل تنظیم  

در تنظیمات مدیر سیستم:

- نوع هفته پیش‌فرض انتخاب شود  

گزارش‌های هفتگی باید بر اساس هر دو تقویم قابل تولید باشند.

---

## ۹. تعطیلات  

**جدول:** `holidays`  

**فیلدها:**

- تاریخ میلادی  
- تاریخ شمسی  
- کشور (IR، TR، …)  
- عنوان تعطیلی  
- آیا آخرهفته است یا خیر  

**کاربرد:**

- نمایش تعطیلات در داشبورد  
- اصلاح تاریخ پیش‌بینی وصول یا پرداخت  
- انتقال خودکار به اولین روز کاری بعد (در صورت فعال بودن تنظیم)  

---

## ۱۰. پیش‌بینی نقدینگی  
گزارش پیش‌بینی:

- ۷ روز آینده  
- ۳۰ روز آینده  
- ۱۸۰ روزه  

با درنظر گرفتن:

- سررسیدها  
- ثبت‌های دستی  
- تعطیلات  

---

## ۱۱. کاربران و سطوح دسترسی  

**نقش‌ها:**

- مشاهده‌گر  
- ثبت‌کننده  
- ناظر  
- مدیر سیستم  

ورود کاربران الزامی است.

---

## ۱۲. ثبت لاگ تغییرات (Audit Log)  

**جدول:** `audit_log`  

ثبت موارد زیر الزامی است:

- ایجاد، ویرایش و حذف ثبت‌های دستی  
- اصلاحات ERP  
- تغییر تنظیمات سیستم  

**فیلدها:**

- نام موجودیت  
- شناسه رکورد  
- مقدار قبلی  
- مقدار جدید  
- کاربر  
- زمان  

---

## ۱۳. ماژول‌های رابط کاربری  

1. مشاهده تراکنش‌های ERP + اصلاحات  
2. فرم ثبت اطلاعات دستی  
3. داشبورد نقدینگی روزانه و هفتگی  
4. داشبورد پیش‌بینی  
5. پنل مدیریت  
6. خروجی اکسل و PDF  
